"""
Stage 5: Exploit Mapping
Map vulnerabilities to available exploits
"""

from typing import Dict, Any
from loguru import logger
from stages.base import BaseStage
from modules.exploit_map.exploit_db import ExploitDBSearch
from modules.exploit_map.metasploit_modules import MetasploitModuleFinder
from modules.exploit_map.cve_lookup import CVELookup


class ExploitMappingStage(BaseStage):
    
    @property
    def name(self) -> str:
        return "Exploit Mapping"
    
    @property
    def description(self) -> str:
        return "Map CVEs to exploits: Exploit-DB, Metasploit modules, PoCs"
    
    async def run(self) -> Dict[str, Any]:
        vuln_data = self.get_previous_stage_data('vuln_scan')
        threat_data = self.get_previous_stage_data('threat_model')
        
        vulnerabilities = vuln_data.get('vulnerabilities', [])
        prioritized_targets = threat_data.get('prioritized_targets', [])
        
        logger.info(f"üó∫Ô∏è Mapping exploits for {len(vulnerabilities)} vulnerabilities")
        
        exploit_db = ExploitDBSearch(self.config)
        msf_finder = MetasploitModuleFinder(self.config)
        cve_lookup = CVELookup(self.config)
        
        exploit_map = []
        
        for vuln in vulnerabilities:
            mapping = {
                'vulnerability': vuln,
                'exploits': [],
                'metasploit_modules': [],
                'cve_details': {}
            }
            
            # Search Exploit-DB
            if vuln.cve_id:
                exploits = await exploit_db.search(vuln.cve_id)
                mapping['exploits'] = exploits
                
                # Find Metasploit modules
                modules = await msf_finder.find_modules(vuln.cve_id)
                mapping['metasploit_modules'] = modules
                
                # Get CVE details
                cve_info = await cve_lookup.lookup(vuln.cve_id)
                mapping['cve_details'] = cve_info
            
            if mapping['exploits'] or mapping['metasploit_modules']:
                exploit_map.append(mapping)
        
        results = {
            'exploit_map': exploit_map,
            'exploitable_count': len(exploit_map)
        }
        
        logger.success(f"‚úÖ Found exploits for {len(exploit_map)} vulnerabilities")
        
        return results
