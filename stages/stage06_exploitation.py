"""
Stage 6: Controlled Exploitation
Verify vulnerabilities with safe PoC execution
"""

from typing import Dict, Any
from loguru import logger
from stages.base import BaseStage
from modules.exploitation.metasploit_client import MetasploitClient
from modules.exploitation.exploit_runner import ExploitRunner
from modules.exploitation.safety_checker import SafetyChecker
from core.models import ExploitResult


class ExploitationStage(BaseStage):
    
    @property
    def name(self) -> str:
        return "Controlled Exploitation"
    
    @property
    def description(self) -> str:
        return "Safe PoC verification with Metasploit and custom exploits"
    
    async def run(self) -> Dict[str, Any]:
        if self.scope.dry_run:
            logger.warning("‚ö†Ô∏è Dry-run mode: Skipping actual exploitation")
            return {'exploit_results': [], 'dry_run': True}
        
        exploit_map_data = self.get_previous_stage_data('exploit_map')
        exploit_map = exploit_map_data.get('exploit_map', [])
        
        logger.info(f"üí• Attempting to verify {len(exploit_map)} exploitable vulnerabilities")
        
        # Safety checks
        safety_checker = SafetyChecker(self.config, self.scope)
        if not await safety_checker.verify_authorization():
            logger.error("‚ùå Authorization verification failed")
            return {'exploit_results': [], 'error': 'Authorization failed'}
        
        msf_client = MetasploitClient(self.config)
        await msf_client.connect()
        
        exploit_results = []
        
        for item in exploit_map[:10]:  # Limit to top 10 for safety
            vuln = item['vulnerability']
            
            # Try Metasploit modules first
            for module in item.get('metasploit_modules', []):
                logger.info(f"üéØ Attempting exploit: {module['name']}")
                
                result = await msf_client.run_exploit(
                    module=module['path'],
                    target=vuln.affected_service,
                    port=vuln.affected_port
                )
                
                exploit_results.append(result)
                
                if result.success:
                    logger.success(f"‚úÖ Exploit successful: {module['name']}")
                    break
        
        await msf_client.disconnect()
        
        results = {
            'exploit_results': exploit_results,
            'successful_exploits': sum(1 for r in exploit_results if r.success)
        }
        
        logger.success(f"‚úÖ Verified {results['successful_exploits']} exploits")
        
        return results
