"""
Stage 7: Post-Exploitation
Credential harvesting, privilege escalation, persistence
"""

from typing import Dict, Any
from loguru import logger
from stages.base import BaseStage
from modules.post_exploit.credential_harvester import CredentialHarvester
from modules.post_exploit.privesc_checker import PrivilegeEscalationChecker
from modules.post_exploit.bloodhound_runner import BloodHoundRunner
from modules.post_exploit.data_exfil_sim import DataExfiltrationSimulator


class PostExploitationStage(BaseStage):
    
    @property
    def name(self) -> str:
        return "Post-Exploitation"
    
    @property
    def description(self) -> str:
        return "Credential harvesting, privilege escalation, AD enumeration"
    
    async def run(self) -> Dict[str, Any]:
        if self.scope.dry_run:
            logger.warning("‚ö†Ô∏è Dry-run mode: Skipping post-exploitation")
            return {'credentials': [], 'dry_run': True}
        
        exploit_data = self.get_previous_stage_data('exploitation')
        exploit_results = exploit_data.get('exploit_results', [])
        
        # Get successful sessions
        sessions = [r for r in exploit_results if r.success and r.session_id]
        
        if not sessions:
            logger.warning("No active sessions for post-exploitation")
            return {'credentials': [], 'privesc_paths': []}
        
        logger.info(f"üîì Post-exploiting {len(sessions)} compromised hosts")
        
        credentials = []
        privesc_paths = []
        ad_data = {}
        
        for session in sessions:
            # Harvest credentials
            harvester = CredentialHarvester(self.config)
            creds = await harvester.harvest(session.session_id)
            credentials.extend(creds)
            
            # Check privilege escalation
            privesc = PrivilegeEscalationChecker(self.config)
            paths = await privesc.check(session.session_id)
            privesc_paths.extend(paths)
        
        # Run BloodHound if AD environment detected
        if any('domain' in str(c.username).lower() for c in credentials):
            logger.info("ü©∏ Running BloodHound for AD enumeration")
            bloodhound = BloodHoundRunner(self.config)
            ad_data = await bloodhound.collect(sessions[0].session_id)
        
        results = {
            'credentials': credentials,
            'privesc_paths': privesc_paths,
            'ad_data': ad_data,
            'compromised_hosts': [s.vulnerability_id for s in sessions]
        }
        
        logger.success(f"‚úÖ Harvested {len(credentials)} credentials")
        
        return results
