"""CVE database lookup via NVD API"""
import asyncio
from typing import Dict, Any
from loguru import logger

try:
    import aiohttp
except ImportError:
    aiohttp = None

class CVELookup:
    def __init__(self, config):
        self.config = config
        self.nvd_api_url = 'https://services.nvd.nist.gov/rest/json/cves/2.0'
    
    async def lookup(self, cve_id: str) -> Dict[str, Any]:
        if not aiohttp:
            return {}
        
        logger.info(f"Looking up {cve_id} in NVD")
        cve_id = cve_id.upper().strip()
        if not cve_id.startswith('CVE-'):
            cve_id = f'CVE-{cve_id}'
        
        try:
            async with aiohttp.ClientSession() as session:
                async with session.get(f'{self.nvd_api_url}?cveId={cve_id}', timeout=30) as resp:
                    if resp.status == 200:
                        data = await resp.json()
                        if data.get('vulnerabilities'):
                            vuln = data['vulnerabilities'][0]
                            cve_data = vuln.get('cve', {})
                            metrics = cve_data.get('metrics', {})
                            cvss_v3 = metrics.get('cvssMetricV31', [{}])[0].get('cvssData', {}) if 'cvssMetricV31' in metrics else {}
                            
                            return {
                                'cve_id': cve_id,
                                'description': cve_data.get('descriptions', [{}])[0].get('value', ''),
                                'published': cve_data.get('published', ''),
                                'cvss_score': cvss_v3.get('baseScore', 0),
                                'severity': cvss_v3.get('baseSeverity', 'UNKNOWN'),
                                'vector_string': cvss_v3.get('vectorString', '')
                            }
            return {}
        except Exception as e:
            logger.error(f"CVE lookup failed: {e}")
            return {}
