"""Generic exploit execution framework"""
import asyncio
import subprocess
from typing import Dict, Any
from datetime import datetime
from loguru import logger

class ExploitRunner:
    def __init__(self, config):
        self.config = config
    
    async def run(self, exploit: Dict, target: str) -> Dict[str, Any]:
        logger.info(f"Running exploit: {exploit.get('name', 'unknown')}")
        
        result = {
            'success': False,
            'exploit': exploit.get('name'),
            'target': target,
            'timestamp': datetime.now().isoformat(),
            'output': '',
            'error': None
        }
        
        try:
            exploit_type = exploit.get('type', 'unknown')
            
            if exploit_type == 'metasploit':
                return await self._run_metasploit(exploit, target)
            elif exploit_type == 'script':
                return await self._run_script(exploit, target)
            elif exploit_type == 'command':
                return await self._run_command(exploit, target)
            else:
                result['error'] = f"Unknown exploit type: {exploit_type}"
                return result
        except Exception as e:
            result['error'] = str(e)
            logger.error(f"Exploit execution failed: {e}")
            return result
    
    async def _run_metasploit(self, exploit: Dict, target: str) -> Dict[str, Any]:
        from modules.exploitation.metasploit_client import MetasploitClient
        
        msf = MetasploitClient(self.config)
        await msf.connect()
        
        result = await msf.run_exploit(
            module=exploit.get('path'),
            target=target,
            port=exploit.get('port', 0)
        )
        
        await msf.disconnect()
        return result.__dict__ if hasattr(result, '__dict__') else result
    
    async def _run_script(self, exploit: Dict, target: str) -> Dict[str, Any]:
        script_path = exploit.get('path')
        args = exploit.get('args', [])
        
        cmd = [script_path] + args + [target]
        
        proc = await asyncio.create_subprocess_exec(
            *cmd,
            stdout=asyncio.subprocess.PIPE,
            stderr=asyncio.subprocess.PIPE
        )
        
        stdout, stderr = await asyncio.wait_for(proc.communicate(), timeout=300)
        
        return {
            'success': proc.returncode == 0,
            'output': stdout.decode('utf-8', errors='ignore'),
            'error': stderr.decode('utf-8', errors='ignore') if stderr else None
        }
    
    async def _run_command(self, exploit: Dict, target: str) -> Dict[str, Any]:
        command = exploit.get('command', '').replace('{target}', target)
        
        proc = await asyncio.create_subprocess_shell(
            command,
            stdout=asyncio.subprocess.PIPE,
            stderr=asyncio.subprocess.PIPE
        )
        
        stdout, stderr = await asyncio.wait_for(proc.communicate(), timeout=60)
        
        return {
            'success': proc.returncode == 0,
            'output': stdout.decode('utf-8', errors='ignore'),
            'error': stderr.decode('utf-8', errors='ignore') if stderr else None
        }
